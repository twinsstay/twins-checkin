<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Self Check-in | Twins Stay</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Noto Sans JP', sans-serif; }
    .camera-container { position: relative; width: 100%; max-width: 500px; margin: 0 auto; overflow: hidden; border-radius: 16px; background: #000; }
    .hidden { display: none; }
    .flex-center { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; }
    .animate-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    select { 
      appearance: none; 
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%234f46e5'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 1rem center; background-size: 1.5em;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased text-center">

  <script>const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx29CpU-crebgErgcnBiwOjeiuNYtZWyYWfHAlxT4ya4ov0LZAvSvvOJ1aKqEBEK5Sj/exec';</script>

  <div id="app" class="flex-center p-4">
    
    <div id="screen-lang" class="w-full max-w-md bg-white rounded-3xl shadow-2xl p-8 animate-in font-sans">
      <h1 class="text-3xl font-black text-indigo-900 mb-2">Welcome to twins stay</h1>
      <p class="text-slate-500 mb-8 italic text-sm text-center">Please select your language</p>
      <div class="grid grid-cols-2 gap-4">
        <button onclick="startCheckin('ja')" class="py-4 bg-indigo-600 text-white rounded-2xl text-lg font-bold shadow-lg active:scale-95 transition col-span-2">æ—¥æœ¬åœ¨ä½ã®æ–¹ (Japanese)</button>
        <button onclick="startCheckin('en')" class="py-4 bg-slate-800 text-white rounded-2xl text-lg font-bold shadow-lg">English</button>
        <button onclick="startCheckin('zh-cn')" class="py-4 bg-slate-800 text-white rounded-2xl text-lg font-bold shadow-lg">ç®€ä½“ä¸­æ–‡</button>
        <button onclick="startCheckin('zh-tw')" class="py-4 bg-slate-800 text-white rounded-2xl text-lg font-bold shadow-lg">ç¹é«”ä¸­æ–‡</button>
        <button onclick="startCheckin('ko')" class="py-4 bg-slate-800 text-white rounded-2xl text-lg font-bold shadow-lg">í•œêµ­ì–´</button>
        <button onclick="startCheckin('es')" class="py-4 bg-slate-800 text-white rounded-2xl text-lg font-bold shadow-lg">EspaÃ±ol</button>
        <button onclick="startCheckin('fr')" class="py-4 bg-slate-800 text-white rounded-2xl text-lg font-bold shadow-lg">FranÃ§ais</button>
      </div>
    </div>

    <div id="screen-stay-info" class="hidden w-full max-w-md bg-white rounded-3xl shadow-2xl p-8 animate-in">
      <h2 id="ui-stay-title" class="text-2xl font-black text-indigo-900 mb-6 text-center font-sans"></h2>
      <div class="space-y-6">
        <div class="bg-indigo-50 p-6 rounded-2xl border-2 border-indigo-100">
          <div class="mb-4">
            <label id="ui-label-people" class="text-sm md:text-lg font-bold text-indigo-700 block mb-2 text-center"></label>
            <select id="numPeople" class="w-full bg-white border-2 border-indigo-200 rounded-xl p-4 font-black text-2xl text-indigo-900 outline-none text-center font-sans"></select>
          </div>
          <div>
            <label id="ui-label-nights" class="text-sm md:text-lg font-bold text-indigo-700 block mb-2 text-center"></label>
            <select id="numNights" class="w-full bg-white border-2 border-indigo-200 rounded-xl p-4 font-black text-2xl text-indigo-900 outline-none text-center font-sans"></select>
          </div>
        </div>
        <button onclick="toGuestForm()" id="ui-btn-stay-next" class="w-full bg-indigo-600 text-white py-5 rounded-2xl text-xl font-bold shadow-xl active:scale-95 transition"></button>
        <button onclick="resetApp()" class="text-slate-400 text-sm mt-4 inline-block font-sans">â† Back</button>
      </div>
    </div>

    <div id="screen-form" class="hidden w-full max-w-2xl bg-white rounded-3xl shadow-2xl p-6 md:p-10 animate-in font-sans">
      <header class="border-b pb-4 mb-6 relative text-left">
        <h2 class="text-2xl font-black text-indigo-900"><span id="ui-form-guest-count"></span> <span id="ui-title"></span></h2>
        <p id="ui-guidance" class="text-sm text-red-600 font-bold mt-2 leading-relaxed"></p>
        <button onclick="backFromForm()" class="absolute top-0 right-0 px-4 py-2 bg-slate-100 rounded-full text-xs font-bold text-slate-500 font-sans">â† Back</button>
      </header>
      
      <form id="checkinForm" class="space-y-6 text-left">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="md:col-span-2">
            <label id="ui-label-name" class="block text-sm font-bold text-slate-700 mb-1 font-sans"></label>
            <input type="text" name="name" required class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-xl text-lg outline-none font-sans">
          </div>
          <div class="md:col-span-2">
            <div class="flex justify-between items-center mb-1 font-sans">
              <label id="ui-label-address" class="block text-sm font-bold text-slate-700 font-sans"></label>
              <button type="button" id="ui-btn-copy-address" onclick="copyLastAddress()" class="hidden text-xs bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full font-bold">å‰ã®ä½æ‰€ã‚’ã‚³ãƒ”ãƒ¼</button>
            </div>
            <textarea name="address" required rows="2" class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-xl text-lg outline-none font-sans"></textarea>
          </div>
          <div><label id="ui-label-job" class="block text-sm font-bold text-slate-700 mb-1 font-sans"></label><input type="text" name="job" class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-xl outline-none text-lg font-sans"></div>
          <div><label id="ui-label-age" class="block text-sm font-bold text-slate-700 mb-1 font-sans"></label><select name="age" id="field-age" class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-xl outline-none text-lg font-sans"></select></div>
          <div class="md:col-span-2 font-sans font-bold">
            <label id="ui-label-gender" class="block text-sm font-bold text-slate-700 mb-2 font-sans"></label>
            <div class="flex flex-wrap gap-4 md:gap-8">
              <label class="flex items-center cursor-pointer"><input type="radio" name="gender" value="Male" checked class="w-5 h-5 text-indigo-600 mr-2"> <span id="ui-val-male"></span></label>
              <label class="flex items-center cursor-pointer"><input type="radio" name="gender" value="Female" class="w-5 h-5 text-indigo-600 mr-2"> <span id="ui-val-female"></span></label>
              <label class="flex items-center cursor-pointer"><input type="radio" name="gender" value="Other" class="w-5 h-5 text-indigo-600 mr-2"> <span id="ui-val-other"></span></label>
            </div>
          </div>
        </div>

        <div id="ui-section-passport" class="pt-4 border-t border-slate-100">
          <div class="flex justify-between items-end mb-2 font-sans font-bold">
            <label id="ui-label-passport" class="block text-sm font-bold text-slate-700"></label>
            <button type="button" id="switchBtn" onclick="toggleCamera()" class="hidden text-xs bg-slate-200 px-4 py-2 rounded-full font-bold text-slate-600">ğŸ”„ Switch Camera</button>
          </div>
          <div class="camera-container aspect-[4/3]">
            <video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
            <canvas id="canvas" class="hidden"></canvas>
            <img id="photoPreview" class="hidden w-full h-full object-cover absolute top-0 left-0">
          </div>
          <div class="mt-4 flex gap-3 font-sans">
            <button type="button" onclick="takePhoto()" id="snapBtn" class="flex-1 bg-slate-800 text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition"></button>
            <button type="button" onclick="retakePhoto()" id="retakeBtn" class="hidden flex-1 bg-amber-500 text-white py-4 rounded-xl font-bold font-sans"></button>
          </div>
        </div>
        <input type="hidden" name="passportData" id="passportData">

        <div class="flex gap-4 pt-4 font-sans font-bold">
          <button type="button" onclick="nextGuest()" id="ui-btn-next-guest" class="flex-1 bg-indigo-100 text-indigo-700 py-5 rounded-2xl shadow-sm hover:bg-indigo-200 transition"></button>
          <button type="button" onclick="toConfirmation()" id="ui-btn-confirm" class="flex-1 bg-indigo-600 text-white py-5 rounded-2xl shadow-xl hover:bg-indigo-700 transition"></button>
        </div>
      </form>
    </div>

    <div id="screen-confirm" class="hidden w-full max-w-2xl bg-white rounded-3xl shadow-2xl p-6 md:p-10 animate-in font-sans">
      <h2 id="ui-confirm-title" class="text-2xl font-black text-indigo-900 mb-2 border-b pb-2 text-left font-sans font-bold"></h2>
      <div id="mismatch-alert" class="hidden bg-red-50 border-2 border-red-200 rounded-xl p-4 mb-6 text-left font-sans font-bold">
        <p id="ui-mismatch-msg" class="text-red-600 font-bold text-sm leading-relaxed font-sans font-bold"></p>
      </div>
      <div id="confirm-list" class="space-y-8 mb-8 text-lg max-h-[50vh] overflow-y-auto px-2 text-left font-sans"></div>
      <div class="flex gap-4 font-sans">
        <button onclick="backToGuestLoop()" id="ui-btn-confirm-back" class="flex-1 py-4 bg-slate-200 rounded-xl font-bold text-slate-600 font-sans font-bold">â† Edit</button>
        <button onclick="showPayment()" id="ui-btn-confirm-next" class="flex-1 py-4 bg-indigo-600 rounded-xl font-bold text-white shadow-lg disabled:bg-slate-300 font-sans font-bold"></button>
      </div>
    </div>

    <div id="screen-payment" class="hidden w-full max-w-lg bg-white rounded-3xl shadow-2xl p-8 text-center animate-in font-sans font-bold">
      <div class="text-5xl mb-4 text-indigo-600 font-sans">ğŸ’°</div>
      <h2 id="ui-pay-amount-label" class="text-slate-500 font-bold mb-1 font-sans font-bold uppercase"></h2>
      <p class="text-5xl font-black text-indigo-600 mb-8 font-sans font-sans font-bold tracking-tighter">Â¥ <span id="payTotal"></span></p>
      <div class="bg-amber-50 border-2 border-amber-200 p-6 rounded-2xl mb-8 font-sans font-bold">
        <p id="ui-pay-instruction" class="text-lg font-bold text-amber-800 leading-relaxed font-sans font-bold"></p>
      </div>
      <button onclick="submitAll()" id="ui-btn-pay-complete" class="w-full bg-green-600 text-white font-black py-5 rounded-2xl text-xl shadow-xl active:scale-95 transition font-sans font-bold font-sans"></button>
    </div>

    <div id="screen-success" class="hidden w-full max-w-lg bg-white rounded-3xl shadow-2xl p-10 text-center animate-in font-sans">
      <div class="text-8xl mb-6 text-center">ğŸ®</div>
      <h2 id="ui-success-msg" class="text-2xl font-bold text-slate-800 mb-8 leading-relaxed text-center font-sans font-bold"></h2>
      <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden mb-4 font-sans font-bold">
        <div id="progressBar" class="bg-indigo-600 h-full w-0" style="width: 0%;"></div>
      </div>
      <p class="text-xs text-slate-400 italic text-center font-sans font-bold">Auto reset in 5 seconds...</p>
    </div>

  </div>

  <script>
    // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ç”Ÿæˆ
    window.addEventListener('DOMContentLoaded', () => {
      const pS = document.getElementById('numPeople');
      for (let i = 1; i <= 6; i++) { let o = document.createElement('option'); o.value = i; o.innerText = i; pS.appendChild(o); }
      const nS = document.getElementById('numNights');
      for (let i = 1; i <= 99; i++) { let o = document.createElement('option'); o.value = i; o.innerText = i; nS.appendChild(o); }
      const aS = document.getElementById('field-age');
      for (let i = 0; i <= 99; i++) { let o = document.createElement('option'); o.value = i; o.innerText = i; aS.appendChild(o); }
    });

    const i18n = {
      ja: {
        passportRequired: false, stayTitle: "å®¿æ³ŠåŸºæœ¬æƒ…å ±", people: "12æ­³ä»¥ä¸Šã®äººæ•°", nights: "å®¿æ³Šæ•°", stayNext: "å®¿æ³Šè€…ã®å…¥åŠ›ã¸é€²ã‚€",
        title: "å®¿æ³Šã‚«ãƒ¼ãƒ‰å…¥åŠ›", name: "æ°å / Name", address: "ä½æ‰€ / Address", copyAddress: "ä»£è¡¨è€…ã®ä½æ‰€ã‚’ã‚³ãƒ”ãƒ¼",
        job: "è·æ¥­ / Occupation", age: "å¹´é½¢ / Age", gender: "æ€§åˆ¥ / Gender", male: "ç”·æ€§", female: "å¥³æ€§", other: "å›ç­”ã—ãªã„",
        passport: "ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã®æ’®å½±", snap: "ğŸ“· ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã‚’æ’®å½±ã™ã‚‹", retake: "ğŸ”„ æ’®ã‚Šç›´ã™", 
        nextGuest: "æ¬¡ã®å®¿æ³Šè€…æƒ…å ±ã‚’å…¥åŠ›", toConfirm: "ç¢ºèªç”»é¢ã¸é€²ã‚€",
        confirmTitle: "å®¿æ³Šè€…å…¨å“¡ã®ç¢ºèª", back: "ä¿®æ­£ã™ã‚‹", next: "ãŠæ”¯æ‰•ã„ã¸é€²ã‚€", payLabel: "ãŠæ”¯æ‰•ã„åˆè¨ˆ(å®¿æ³Šç¨)",
        payMsg: "å‚™ãˆä»˜ã‘ã®BOXã¸å®¿æ³Šç¨ã‚’ãŠæ”¯æ‰•ã„ãã ã•ã„", payComplete: "æ”¯æ‰•ã„ãŒå®Œäº†ã—ã¾ã—ãŸ",
        success: "ãŠæ”¯æ‰•ã„ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼<br>é«˜å±±ã§ã®ã”æ»åœ¨ã‚’ãŠæ¥½ã—ã¿ãã ã•ã„ï¼",
        guidance: "ã”å®¿æ³Šè€…æ§˜å…¨å“¡åˆ†ï¼ˆ12æ­³ä»¥ä¸‹ã‚‚å«ã‚€ï¼‰ã®æƒ…å ±å…¥åŠ›ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™",
        mismatchMsg: "âš ï¸ æœ€åˆã«é¸æŠã—ãŸäººæ•°ã¨ç™»éŒ²ã•ã‚ŒãŸå®¿æ³Šè€…ã®å¹´é½¢ã«ç›¸é•ãŒã‚ã‚Šã¾ã™ã€‚å…¥åŠ›ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚"
      },
      en: {
        passportRequired: true, stayTitle: "Stay Details", people: "Number of People (12+)", nights: "Nights", stayNext: "Next",
        title: "Guest Registration", name: "Full Name", address: "Residential Address", copyAddress: "Same as previous",
        job: "Occupation", age: "Age", gender: "Gender", male: "Male", female: "Female", other: "Other",
        passport: "Passport", snap: "ğŸ“· Take Passport Photo", retake: "ğŸ”„ Retake",
        nextGuest: "Add Next Guest", toConfirm: "Review All Info",
        confirmTitle: "Review Information", back: "Edit", next: "Proceed to Payment", payLabel: "Tax Total",
        payMsg: "Please pay the accommodation tax into the box provided", payComplete: "Payment Completed",
        success: "Thank you!<br>Enjoy your wonderful stay!",
        guidance: "Please enter information for all guests (including children).",
        mismatchMsg: "âš ï¸ Number of adults detected does not match initial selection."
      },
      es: {
        passportRequired: true, stayTitle: "InformaciÃ³n", people: "Personas (12+)", nights: "Noches", stayNext: "Siguiente",
        title: "Ficha de Registro", name: "Nombre", address: "DirecciÃ³n", copyAddress: "Misma direcciÃ³n",
        job: "OcupaciÃ³n", age: "Edad", gender: "GÃ©nero", male: "Hombre", female: "Mujer", other: "No decir",
        passport: "Pasaporte", snap: "ğŸ“· Foto del pasaporte", retake: "ğŸ”„ Repetir",
        nextGuest: "AÃ±adir acompaÃ±ante", toConfirm: "Revisar todo",
        confirmTitle: "Confirmar Datos", back: "Modificar", next: "Ir al Pago", payLabel: "Tasa Total",
        payMsg: "Por favor, deposite la tasa turÃ­stica en la caja proporcionada", payComplete: "Pago Realizado",
        success: "Â¡Gracias!<br>Â¡Disfrute de su estancia!",
        guidance: "Introduzca los datos de todos los huÃ©spedes (incluidos niÃ±os).",
        mismatchMsg: "âš ï¸ Incoherencia en el nÃºmero de adultos."
      },
      fr: {
        passportRequired: true, stayTitle: "SÃ©jour", people: "Personnes (12+)", nights: "Nuits", stayNext: "Suivant",
        title: "Enregistrement", name: "Nom Complet", address: "Adresse", copyAddress: "MÃªme adresse",
        job: "Occupation", age: "Ã‚ge", gender: "Genre", male: "Homme", female: "Femme", other: "Non prÃ©cisÃ©",
        passport: "Passeport", snap: "ğŸ“· Photo du passeport", retake: "ğŸ”„ Reprendre",
        nextGuest: "Ajouter client", toConfirm: "VÃ©rifier",
        confirmTitle: "VÃ©rification", back: "Modifier", next: "Paiement", payLabel: "Taxe de SÃ©jour",
        payMsg: "Veuillez dÃ©poser la taxe de sÃ©jour dans la boÃ®te prÃ©vue", payComplete: "Paiement EffectuÃ©",
        success: "Merci !<br>Bon sÃ©jour Ã  Takayama !",
        guidance: "Veuillez saisir les informaÃ§Ãµes de tous les clients.",
        mismatchMsg: "âš ï¸ IncohÃ©rence du nombre d'adultes."
      },
      "zh-cn": {
        passportRequired: true, stayTitle: "ä½å®¿ä¿¡æ¯", people: "å…¥ä½äººæ•° (12å²ä»¥ä¸Š)", nights: "ä½å®¿å¤©æ•°", stayNext: "ä¸‹ä¸€æ­¥",
        title: "å…¥ä½ç™»è®°è¡¨", name: "å§“å", address: "å±…ä½åœ°å€", copyAddress: "ä½¿ç”¨åŒä¼´åœ°å€",
        job: "èŒä¸š", age: "å¹´é¾„", gender: "æ€§åˆ«", male: "ç”·", female: "å¥³", other: "ä¸ä¾¿é€éœ²",
        passport: "æ‹æ‘„æŠ¤ç…§", snap: "ğŸ“· æ‹æ‘„æŠ¤ç…§", retake: "ğŸ”„ é‡æ‹",
        nextGuest: "æ·»åŠ éšè¡Œäººå‘˜", toConfirm: "æ ¸å¯¹ä¿¡æ¯",
        confirmTitle: "ç¡®è®¤å…¥ä½ä¿¡æ¯", back: "ä¿®æ”¹", next: "å»æ”¯ä»˜", payLabel: "å®¿æ³Šç¨æ€»é¢",
        payMsg: "è¯·å°†å®¿æ³Šç¨æ”¾å…¥æŒ‡å®šçš„ç¨ç®±å†…", payComplete: "æ”¯ä»˜å®Œæˆ",
        success: "æ„Ÿè°¢ï¼<br>ç¥æ‚¨åœ¨é«˜å±±åº¦è¿‡æ„‰å¿«çš„æ—¶å…‰ï¼",
        guidance: "è¯·å¡«å†™æ‰€æœ‰éšè¡Œäººå‘˜ï¼ˆåŒ…æ‹¬å„¿ç«¥ï¼‰çš„ä¿¡æ¯ã€‚",
        mismatchMsg: "âš ï¸ äººæ•°ä¸ç¬¦ï¼Œè¯·ä¿®æ­£ã€‚"
      },
      "zh-tw": {
        passportRequired: true, stayTitle: "ä½å®¿è³‡è¨Š", people: "å…¥ä½äººæ•¸ (12æ­²ä»¥ä¸Š)", nights: "ä½å®¿å¤©æ•¸", stayNext: "ä¸‹ä¸€æ­¥",
        title: "å…¥ä½ç™»è¨˜è¡¨", name: "å§“å", address: "å±…ä½åœ°å€", copyAddress: "ä½¿ç”¨åŒä¼´åœ°å€",
        job: "è·æ¥­", age: "å¹´é½¡", gender: "æ€§åˆ¥", male: "ç”·", female: "å¥³", other: "ä¸ä¾¿é€éœ²",
        passport: "æ‹æ”è­·ç…§", snap: "ğŸ“· æ‹æ”è­·ç…§", retake: "ğŸ”„ é‡æ‹",
        nextGuest: "æ·»åŠ éš¨è¡Œäººå“¡", toConfirm: "æ ¸å°è³‡è¨Š",
        confirmTitle: "ç¢ºèªå…¥ä½è³‡è¨Š", back: "ä¿®æ”¹", next: "å»æ”¯ä»˜", payLabel: "å®¿æ³Šç¨…ç¸½é¡",
        payMsg: "è«‹å°‡å®¿æ³Šç¨…æ”¾å…¥æŒ‡å®šçš„ç¨…ç®±å…§", payComplete: "æ”¯ä»˜å®Œæˆ",
        success: "æ„Ÿè¬ï¼<br>ç¥æ‚¨åœ¨é«˜å±±åº¦éæ„‰å¿«çš„æ™‚å…‰ï¼",
        guidance: "è«‹å¡«å¯«æ‰€æœ‰éš¨è¡Œäººå“¡ï¼ˆåŒ…æ‹¬å…’ç«¥ï¼‰çš„è³‡è¨Šã€‚",
        mismatchMsg: "âš ï¸ äººæ•¸ä¸ç¬¦ï¼Œè«‹ä¿®æ­£ã€‚"
      },
      ko: {
        passportRequired: true, stayTitle: "ìˆ™ë°• ì •ë³´", people: "ìˆ™ë°• ì¸ì› (12ì„¸ ì´ìƒ)", nights: "ìˆ™ë°• ì¼ìˆ˜", stayNext: "ë‹¤ìŒ",
        title: "íˆ¬ìˆ™ê° ëª…ë¶€ ì‘ì„±", name: "ì„±í•¨", address: "ì£¼ì†Œ", copyAddress: "ë™í–‰ì¸ê³¼ ë™ì¼ ì£¼ì†Œ",
        job: "ì§ì—…", age: "ì—°ë ¹", gender: "ì„±ë³„", male: "ë‚¨ì„±", female: "ì—¬ì„±", other: "ì‘ë‹µì•ˆí•¨",
        passport: "ì—¬ê¶Œ ì´¬ì˜", snap: "ğŸ“· ì—¬ê¶Œ ì‚¬ì§„ ì´¬ì˜", retake: "ğŸ”„ ë‹¤ì‹œ ì´¬ì˜",
        nextGuest: "ë‹¤ìŒ íˆ¬ìˆ™ê° ì¶”ê°€", toConfirm: "ì •ë³´ í™•ì¸",
        confirmTitle: "ë‚´ìš© í™•ì¸", back: "ìˆ˜ì •í•˜ê¸°", next: "ê²°ì œí•˜ê¸°", payLabel: "ì´ ìˆ™ë°•ì„¸",
        payMsg: "ë¹„ì¹˜ëœ ì „ìš© ë°•ìŠ¤ì— ìˆ™ë°•ì„¸ë¥¼ ì§€ë¶ˆí•´ ì£¼ì„¸ìš”", payComplete: "ê²°ì œ ì™„ë£Œ",
        success: "ê°ì‚¬í•©ë‹ˆë‹¤!<br>ë‹¤ì¹´ì•¼ë§ˆì—ì„œ ì¦ê±°ìš´ ì‹œê°„ ë³´ë‚´ì„¸ìš”!",
        guidance: "ì–´ë¦°ì´ë¥¼ í¬í•¨í•œ ì „ì›ì˜ ì •ë³´ë¥¼ ì…ë ¥í•´ ì£¼ì‹­ì‹œì˜¤.",
        mismatchMsg: "âš ï¸ ì¸ì› ì •ë³´ ë¶ˆì¼ì¹˜ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."
      }
    };

    let selectedLang = 'ja';
    let currentStream = null;
    let currentFacingMode = 'user';
    let guests = [];
    let currentGuestIdx = 0;

    function showScreen(screenId) {
      ['screen-lang', 'screen-stay-info', 'screen-form', 'screen-confirm', 'screen-payment', 'screen-success'].forEach(id => {
        const el = document.getElementById(id); if (el) el.classList.add('hidden');
      });
      document.getElementById(screenId).classList.remove('hidden'); window.scrollTo(0,0);
    }

    function resetApp() {
      if (currentStream) currentStream.getTracks().forEach(t => t.stop());
      currentStream = null; guests = []; currentGuestIdx = 0;
      document.getElementById('checkinForm').reset(); showScreen('screen-lang');
    }

    function startCheckin(lang) {
      selectedLang = lang; const t = i18n[lang];
      document.getElementById('ui-stay-title').innerText = t.stayTitle;
      document.getElementById('ui-label-people').innerText = t.people;
      document.getElementById('ui-label-nights').innerText = t.nights;
      document.getElementById('ui-btn-stay-next').innerText = t.stayNext;
      showScreen('screen-stay-info');
    }

    function toGuestForm() { applyI18nToForm(); updateGuestFormDisplay(); showScreen('screen-form'); }

    function applyI18nToForm() {
      const t = i18n[selectedLang];
      document.getElementById('ui-title').innerText = t.title;
      document.getElementById('ui-guidance').innerText = t.guidance;
      document.getElementById('ui-label-name').innerText = t.name;
      document.getElementById('ui-label-address').innerText = t.address;
      document.getElementById('ui-btn-copy-address').innerText = t.copyAddress;
      document.getElementById('ui-label-job').innerText = t.job;
      document.getElementById('ui-label-age').innerText = t.age;
      document.getElementById('ui-label-gender').innerText = t.gender;
      document.getElementById('ui-val-male').innerText = t.male;
      document.getElementById('ui-val-female').innerText = t.female;
      document.getElementById('ui-val-other').innerText = t.other;
      document.getElementById('ui-btn-next-guest').innerText = t.nextGuest;
      document.getElementById('ui-btn-confirm').innerText = t.toConfirm;
      
      const pSec = document.getElementById('ui-section-passport');
      if (t.passportRequired) {
        pSec.classList.remove('hidden'); 
        document.getElementById('ui-label-passport').innerText = t.passport;
        document.getElementById('snapBtn').innerText = t.snap;
        document.getElementById('retakeBtn').innerText = t.retake;
        initCamera();
      } else { pSec.classList.add('hidden'); }
    }

    function saveCurrentGuestData() {
      const f = document.getElementById('checkinForm');
      const d = {
        name: f.name.value, address: f.address.value, job: f.job.value, age: f.age.value,
        gender: f.querySelector('input[name="gender"]:checked').value,
        passportData: document.getElementById('passportData').value
      };
      guests[currentGuestIdx] = d; return d;
    }

    function updateGuestFormDisplay() {
      document.getElementById('ui-form-guest-count').innerText = `#${currentGuestIdx + 1}`;
      const cpB = document.getElementById('ui-btn-copy-address');
      (currentGuestIdx > 0) ? cpB.classList.remove('hidden') : cpB.classList.add('hidden');
      
      if (guests[currentGuestIdx]) {
        const d = guests[currentGuestIdx]; const f = document.getElementById('checkinForm');
        f.name.value = d.name; f.address.value = d.address; f.job.value = d.job; f.age.value = d.age;
        f.querySelector(`input[name="gender"][value="${d.gender}"]`).checked = true;
        document.getElementById('passportData').value = d.passportData;
        if (d.passportData) {
            document.getElementById('photoPreview').src = d.passportData;
            document.getElementById('photoPreview').classList.remove('hidden');
            document.getElementById('video').classList.add('hidden');
            document.getElementById('snapBtn').classList.add('hidden');
            document.getElementById('retakeBtn').classList.remove('hidden');
        } else { retakePhoto(); }
      } else { document.getElementById('checkinForm').reset(); retakePhoto(); }
    }

    function copyLastAddress() { if (currentGuestIdx > 0) document.getElementById('checkinForm').address.value = guests[currentGuestIdx - 1].address; }

    function nextGuest() {
      const f = document.getElementById('checkinForm');
      if (!f.name.value || !f.address.value) return alert(i18n[selectedLang].alertField || "Field required");
      if (i18n[selectedLang].passportRequired && !document.getElementById('passportData').value) return alert(i18n[selectedLang].alertPhoto || "Photo required");
      saveCurrentGuestData(); currentGuestIdx++; updateGuestFormDisplay(); window.scrollTo(0,0);
    }

    function backFromForm() {
      if (currentGuestIdx > 0) { saveCurrentGuestData(); currentGuestIdx--; updateGuestFormDisplay(); } 
      else { showScreen('screen-stay-info'); }
    }

    function toConfirmation() {
      const f = document.getElementById('checkinForm');
      if (!f.name.value || !f.address.value) return alert(i18n[selectedLang].alertField || "Field required");
      saveCurrentGuestData(); const t = i18n[selectedLang];
      
      const initial12Plus = Number(document.getElementById('numPeople').value);
      const actual12Plus = guests.filter(g => Number(g.age) >= 12).length;
      const alertBox = document.getElementById('mismatch-alert');
      const nextBtn = document.getElementById('ui-btn-confirm-next');
      
      if (initial12Plus !== actual12Plus) {
        alertBox.classList.remove('hidden');
        document.getElementById('ui-mismatch-msg').innerText = t.mismatchMsg;
        nextBtn.disabled = true;
      } else {
        alertBox.classList.add('hidden');
        nextBtn.disabled = false;
      }

      const list = document.getElementById('confirm-list'); list.innerHTML = "";
      guests.forEach((g, i) => {
        let genT = t.male; if(g.gender === "Female") genT = t.female; if(g.gender === "Other") genT = t.other;
        const item = document.createElement('div');
        item.className = "bg-slate-50 p-4 rounded-2xl border border-slate-200 relative overflow-hidden animate-in";
        item.innerHTML = `
          <div class="absolute top-0 right-0 bg-indigo-600 text-white px-3 py-1 text-xs font-bold">#${i+1}</div>
          <div class="space-y-1">
            <p class="text-xs text-slate-400 font-bold uppercase text-left">${t.name}</p><p class="font-black text-lg text-slate-800 text-left font-sans">${g.name}</p>
            <p class="text-xs text-slate-400 font-bold uppercase pt-2 text-left">${t.address}</p><p class="text-slate-600 leading-tight text-left font-sans">${g.address}</p>
            <div class="flex gap-4 pt-2 text-left">
              <div><p class="text-[10px] text-slate-400 font-bold uppercase text-left font-sans">${t.age}</p><p class="font-bold text-left font-sans">${g.age}</p></div>
              <div><p class="text-[10px] text-slate-400 font-bold uppercase text-left font-sans font-sans">${t.gender}</p><p class="font-bold text-left font-sans font-sans">${genT}</p></div>
            </div>
          </div>`;
        list.appendChild(item);
      });
      document.getElementById('ui-confirm-title').innerText = t.confirmTitle;
      document.getElementById('ui-btn-confirm-next').innerText = t.next;
      showScreen('screen-confirm');
    }

    function backToGuestLoop() { showScreen('screen-form'); if (i18n[selectedLang].passportRequired) initCamera(); }

    function showPayment() {
      const t = i18n[selectedLang];
      const tot = guests.filter(g => Number(g.age) >= 12).length * document.getElementById('numNights').value * 100;
      document.getElementById('payTotal').innerText = tot.toLocaleString();
      document.getElementById('ui-pay-amount-label').innerText = t.payLabel;
      document.getElementById('ui-pay-instruction').innerText = t.payMsg;
      document.getElementById('ui-btn-pay-complete').innerText = t.payComplete;
      showScreen('screen-payment');
    }

    async function submitAll() {
      const b = document.getElementById('ui-btn-pay-complete'); b.disabled = true; b.innerHTML = 'â³ Processing...';
      const p = { selectedLang: selectedLang, numPeople: document.getElementById('numPeople').value, numNights: document.getElementById('numNights').value, guests: guests };
      
      try {
        await fetch(GAS_WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify(p),
          mode: 'no-cors' 
        });
        showSuccess();
      } catch (e) {
        alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        b.disabled = false;
        b.innerText = i18n[selectedLang].payComplete;
      }
    }

    function showSuccess() {
      document.getElementById('ui-success-msg').innerHTML = i18n[selectedLang].success;
      showScreen('screen-success'); const bar = document.getElementById('progressBar');
      bar.style.transition = "none"; bar.style.width = "100%";
      setTimeout(() => { bar.style.transition = "width 5s linear"; bar.style.width = "0%"; }, 100);
      setTimeout(() => { resetApp(); }, 5000);
    }

    async function initCamera() {
      if (currentStream) { currentStream.getTracks().forEach(t => t.stop()); currentStream = null; }
      try {
        currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode } });
        const video = document.getElementById('video');
        video.srcObject = currentStream;
        video.onloadedmetadata = () => { video.play(); };
      } catch (e) { alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
    }

    function toggleCamera() { currentFacingMode = (currentFacingMode === 'user' ? 'environment' : 'user'); initCamera(); }

    function takePhoto() {
      const v = document.getElementById('video'); const c = document.getElementById('canvas');
      c.width = v.videoWidth; c.height = v.videoHeight; const ctx = c.getContext('2d');
      ctx.drawImage(v, 0, 0); const data = c.toDataURL('image/jpeg', 0.8);
      document.getElementById('passportData').value = data; document.getElementById('photoPreview').src = data;
      document.getElementById('photoPreview').classList.remove('hidden'); v.classList.add('hidden');
      document.getElementById('snapBtn').classList.add('hidden'); document.getElementById('retakeBtn').classList.remove('hidden'); document.getElementById('switchBtn').classList.add('hidden');
    }

    function retakePhoto() {
      document.getElementById('passportData').value = ""; document.getElementById('photoPreview').classList.add('hidden');
      document.getElementById('video').classList.remove('hidden'); document.getElementById('snapBtn').classList.remove('hidden');
      document.getElementById('retakeBtn').classList.add('hidden'); if (i18n[selectedLang].passportRequired) initCamera();
    }
  </script>
</body>
</html>
